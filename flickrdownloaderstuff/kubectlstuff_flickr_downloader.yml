---
# kubectlstuff_flickr_downloader.yml
# Per-user Flickr download Jobs + operator Deployment that restarts failed Jobs.
# Re-run via: ansible-playbook kubectlstuff.yml --tags flickr_downloader

- name: Create flickr-downloader namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: flickr-downloader

# Variables defined in roles/kubectlstuff/defaults/main.yml
# - name: Set flickr-downloader variables
#   set_fact:
#     flickr_users:
#       - "myuser"
#     flickr_host_path_prefix: "/mnt/nfs/flickr-downloader_shared"
#     flickr_dockerconfigjson: "eyJhdXRocyI6e319fQ=="
#     flickr_download_image: "localhost/flickr-download:latest"
#     flickr_operator_check_interval: 60
#     flickr_operator_restart_delay: 3600
#     flickr_data_dir: "/home/poduser/flickr-backup"
#     flickr_immich_api_key: "LALAL_SECRET_LALALA"
#     flickr_immich_instance_url: "https://immich.immich.svc.cluster.local"

- name: Create privateregcred secret in flickr-downloader namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: privateregcred
        namespace: flickr-downloader
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: "{{ flickr_dockerconfigjson }}"

- name: Delete orphaned flickr-downloader-{{ flickr_user | default('***') }} pods
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Pod
    namespace: flickr-downloader
    label_selectors:
      - job-name=flickr-downloader-{{ flickr_user }}
  loop: "{{ flickr_users }}"
  loop_control:
    loop_var: flickr_user

- name: Delete previous flickr-downloader-{{ flickr_user | default('***') }} job
  kubernetes.core.k8s:
    state: absent
    api_version: batch/v1
    kind: Job
    name: flickr-downloader-{{ flickr_user }}
    namespace: flickr-downloader
  loop: "{{ flickr_users }}"
  loop_control:
    loop_var: flickr_user

- name: Create flickr-downloader-{{ flickr_user | default('***') }} job
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: flickr-downloader-{{ flickr_user }}
        namespace: flickr-downloader
      spec:
        backoffLimit: 0
        template:
          spec:
            restartPolicy: Never
            imagePullSecrets:
              - name: privateregcred
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              fsGroup: 1000
            containers:
              - name: flickr-downloader-{{ flickr_user }}
                image: "{{ flickr_download_image }}"
                imagePullPolicy: Always
                # command: ["tail", "-f", "/dev/null"]
                # command: ["/entrypoint.sh", "download", "{{ flickr_user }}"]
                command: ["/entrypoint.sh", "download_then_upload", "{{ flickr_user }}"]
                env:
                  - name: DATA_DIR
                    value: "/home/poduser/flickr-backup"
                  - name: IMMICH_API_KEY
                    value: "{{ flickr_immich_api_key }}"
                  - name: IMMICH_INSTANCE_URL
                    value: "{{ flickr_immich_instance_url }}"
                  - name: BACKOFF_EXIT_ON_429
                    value: "true"
                  - name: HOME
                    value: /home/poduser
                  - name: TZ
                    value: Europe/Berlin
                resources:
                  requests:
                    cpu: 250m
                    memory: 1Gi
                  limits:
                    cpu: 2000m
                    memory: 2Gi
                volumeMounts:
                  - name: flickr-config
                    mountPath: /home/poduser
                  - name: flickr-backup
                    mountPath: /home/poduser/flickr-backup
                  - name: flickr-cache
                    mountPath: /home/poduser/flickr-cache
            volumes:
              - name: flickr-config
                hostPath:
                  path: "{{ flickr_host_path_prefix }}/{{ flickr_user }}/flickr-config"
                  type: Directory
              - name: flickr-backup
                hostPath:
                  path: "{{ flickr_host_path_prefix }}/{{ flickr_user }}/flickr-backup"
                  type: Directory
              - name: flickr-cache
                hostPath:
                  path: "{{ flickr_host_path_prefix }}/{{ flickr_user }}/flickr-cache"
                  type: Directory
  loop: "{{ flickr_users }}"
  loop_control:
    loop_var: flickr_user

- name: Create flickr-operator ServiceAccount
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: flickr-operator
        namespace: flickr-downloader

- name: Create flickr-operator Role
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: Role
      metadata:
        name: flickr-operator
        namespace: flickr-downloader
      rules:
        - apiGroups: ["batch"]
          resources: ["jobs"]
          verbs: ["get", "list", "create", "delete"]
        - apiGroups: [""]
          resources: ["pods"]
          verbs: ["get", "list", "delete"]
        - apiGroups: [""]
          resources: ["pods/log"]
          verbs: ["get"]

- name: Create flickr-operator RoleBinding
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: flickr-operator
        namespace: flickr-downloader
      subjects:
        - kind: ServiceAccount
          name: flickr-operator
          namespace: flickr-downloader
      roleRef:
        kind: Role
        name: flickr-operator
        apiGroup: rbac.authorization.k8s.io

- name: Create flickr-operator Deployment
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: flickr-operator
        namespace: flickr-downloader
        labels:
          app: flickr-operator
        annotations:
          keel.sh/policy: force
          keel.sh/match-tag: "true"
          keel.sh/pollSchedule: "@every 24h"
          keel.sh/trigger: poll
      spec:
        replicas: 1
        strategy:
          type: Recreate
        selector:
          matchLabels:
            app: flickr-operator
        template:
          metadata:
            labels:
              app: flickr-operator
          spec:
            serviceAccountName: flickr-operator
            containers:
              - name: flickr-operator
                imagePullPolicy: Always
                image: xomoxcc/flickr-immich-k8s-sync-operator:latest
#                image: python:3.14-slim
#                command:
#                  - bash
#                  - -c
#                  - "echo flickr-operator init started && pip install --no-cache-dir kubernetes && exec python /scripts/flickr_operator.py"
                env:
                  - name: NAMESPACE
                    value: "flickr-downloader"
                  - name: JOB_NAMES
                    value: "{% for u in flickr_users %}flickr-downloader-{{ u }}{% if not loop.last %},{% endif %}{% endfor %}"
                  - name: CHECK_INTERVAL
                    value: "{{ flickr_operator_check_interval | string }}"
                  - name: RESTART_DELAY
                    value: "{{ flickr_operator_restart_delay | string }}"
                  - name: SKIP_DELAY_ON_OOM
                    value: "true"
                resources:
                  requests:
                    cpu: 50m
                    memory: 64Mi
                  limits:
                    cpu: 1500m
                    memory: 128Mi
#                volumeMounts:
#                  - name: operator-script
#                    mountPath: /scripts
#                    readOnly: true
#            volumes:
#              - name: operator-script
#                configMap:
#                  name: flickr-operator-script
#                  defaultMode: 0755
